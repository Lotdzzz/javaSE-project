# â— åå°„

åå°„ï¼ˆReflectionï¼‰ æ˜¯Javaè¯­è¨€çš„ä¸€é¡¹å¼ºå¤§ç‰¹æ€§ï¼Œå®ƒå…è®¸ç¨‹åºåœ¨è¿è¡ŒçŠ¶æ€ä¸­ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªç±»çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼›å¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„ä»»æ„å±æ€§å’Œæ–¹æ³•ã€‚ç®€å•æ¥è¯´ï¼Œåå°„å°±åƒç»™Javaç±»"ç…§é•œå­"ï¼Œèƒ½å¤Ÿçœ‹æ¸…ç±»çš„å†…éƒ¨ç»“æ„ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æœ‰ä¸€ä¸ªå¯†å°çš„ç›’å­ï¼ˆUserç±»ï¼‰ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä½ åªèƒ½é€šè¿‡ç›’å­ä¸Šçš„å‡ ä¸ªæŒ‰é’®ï¼ˆå…¬å…±æ–¹æ³•ï¼‰æ¥æ“ä½œå®ƒã€‚ä½†æœ‰æ—¶å€™ï¼Œä½ éœ€è¦ï¼š

- çŸ¥é“ç›’å­å†…éƒ¨æœ‰ä»€ä¹ˆé›¶ä»¶ï¼ˆå­—æ®µï¼‰
 - çœ‹çœ‹ç›’å­æœ‰å“ªäº›éšè—åŠŸèƒ½ï¼ˆç§æœ‰æ–¹æ³•ï¼‰
 - åœ¨ä¸çŸ¥é“ç›’å­å…·ä½“å‹å·çš„æƒ…å†µä¸‹æ“ä½œå®ƒï¼ˆåŠ¨æ€åŠ è½½ï¼‰
 - åå°„å°±æ˜¯ç»™ä½ ä¸€ä¸ªXå…‰æœºï¼Œè®©ä½ èƒ½é€è§†è¿™ä¸ªç›’å­ï¼Œçœ‹åˆ°å¹¶æ“ä½œå†…éƒ¨çš„ä¸€åˆ‡ï¼

**å®ä¾‹Userç±»ï¼š**

```java
package com.example.model;

import lombok.Data;
import lombok.Builder;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;

import java.time.LocalDateTime;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class User {
    // åŸºæœ¬å±æ€§
    private Long id;
    private String username;
    private String password;
    private String email;
    private String phone;
    private String nickname;
    private String realName;

    // æ•°å€¼å±æ€§
    private int age;
    private double score;

    // å¸ƒå°”å±æ€§
    private boolean active;
    private Boolean verified;

    // æ—¥æœŸå±æ€§
    private LocalDateTime createTime;

    // å¤æ‚ç±»å‹
    private List<String> roles;

    // é™æ€å¸¸é‡
    public static final String DEFAULT_ROLE = "USER";
    public static final int MAX_AGE = 150;

    // æšä¸¾
    public enum Gender {
        MALE, FEMALE, UNKNOWN
    }
    private Gender gender;

    // æ„é€ æ–¹æ³•
    public User(String username, String email) {
        this.username = username;
        this.email = email;
        this.createTime = LocalDateTime.now();
        this.active = true;
    }

    // è‡ªå®šä¹‰æ–¹æ³•
    public String getDisplayName() {
        return nickname != null ? nickname : username;
    }

    public boolean isAdult() {
        return age >= 18;
    }

    private void privateMethod() {
        System.out.println("This is a private method");
    }

    public static User createDefault() {
        return User.builder()
                .username("default")
                .email("default@example.com")
                .age(18)
                .active(true)
                .build();
    }

    // é‡å†™toString
    @Override
    public String toString() {
        return String.format("User{id=%d, username='%s', email='%s', age=%d, active=%s}",
                id, username, email, age, active);
    }
}
```

**Userç±»çš„æ­£å¸¸ä½¿ç”¨ vs åå°„ä½¿ç”¨**

```java
// ç¼–è¯‘æ—¶å°±çŸ¥é“è¦åˆ›å»ºUserå¯¹è±¡
User user = new User("å¼ ä¸‰", "zhangsan@example.com");
user.setAge(25);
System.out.println(user.getDisplayName());
```

```java
// è¿è¡Œæ—¶æ‰çŸ¥é“è¦æ“ä½œUserç±»
Class<?> clazz = Class.forName("com.example.model.User");
Object user = clazz.getConstructor(String.class, String.class)
                  .newInstance("å¼ ä¸‰", "zhangsan@example.com");
Method setAgeMethod = clazz.getMethod("setAge", int.class);
setAgeMethod.invoke(user, 25);
```

## â—‹ åå°„çš„å››å¤§æ ¸å¿ƒæ“ä½œ

### â–³ è·å–Classå¯¹è±¡

æ¯ä¸ªç±»åœ¨JVMä¸­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„Classå¯¹è±¡ï¼Œå°±åƒäººçš„èº«ä»½è¯ï¼š
**è·å–Classå¯¹è±¡çš„æ–¹æ³•**

| æ–¹æ³•å                    | æ‰€å±ç±»        | æè¿°                      | è¿”å›ç±»å‹   | ç¤ºä¾‹                                                         |
| ------------------------- | ------------- | ------------------------- | ---------- | ------------------------------------------------------------ |
| `.class`                  | ç±»å­—é¢é‡      | é€šè¿‡ç±»åç›´æ¥è·å–Classå¯¹è±¡ | `Class<T>` | `User.class`                                                 |
| `getClass()`              | `Object`      | é€šè¿‡å¯¹è±¡å®ä¾‹è·å–Classå¯¹è±¡ | `Class<?>` | `user.getClass()`                                            |
| `Class.forName()`         | `Class`       | é€šè¿‡å®Œæ•´ç±»åè·å–Classå¯¹è±¡ | `Class<?>` | `Class.forName("com.example.model.User")`                    |
| `ClassLoader.loadClass()` | `ClassLoader` | é€šè¿‡ç±»åŠ è½½å™¨è·å–Classå¯¹è±¡ | `Class<?>` | `ClassLoader.getSystemClassLoader().loadClass("com.example.model.User")` |

**è·å–ç±»ä¿¡æ¯çš„æ–¹æ³•**

| æ–¹æ³•                 | è¯´æ˜         | ç¤ºä¾‹                            | è¿”å›å€¼               |
| -------------------- | ------------ | ------------------------------- | -------------------- |
| `getName()`          | è·å–å…¨é™å®šå | `User.class.getName()`          | `"com.example.User"` |
| `getSimpleName()`    | è·å–ç®€å•ç±»å | `User.class.getSimpleName()`    | `"User"`             |
| `getCanonicalName()` | è·å–è§„èŒƒç±»å | `User.class.getCanonicalName()` | `"com.example.User"` |
| `getPackage()`       | è·å–åŒ…ä¿¡æ¯   | `User.class.getPackage()`       | Packageå¯¹è±¡          |
| `getModifiers()`     | è·å–ä¿®é¥°ç¬¦   | `User.class.getModifiers()`     | intå€¼                |
| `getSuperclass()`    | è·å–çˆ¶ç±»     | `User.class.getSuperclass()`    | Classå¯¹è±¡            |
| `getInterfaces()`    | è·å–æ¥å£     | `User.class.getInterfaces()`    | Class[]æ•°ç»„          |

**ç±»å‹æ£€æŸ¥æ–¹æ³•**

| æ–¹æ³•                      | è¯´æ˜           | ç¤ºä¾‹                                        | è¿”å›å€¼  |
| ------------------------- | -------------- | ------------------------------------------- | ------- |
| `isInterface()`           | æ˜¯å¦æ˜¯æ¥å£     | `User.class.isInterface()`                  | boolean |
| `isArray()`               | æ˜¯å¦æ˜¯æ•°ç»„     | `User.class.isArray()`                      | boolean |
| `isEnum()`                | æ˜¯å¦æ˜¯æšä¸¾     | `User.class.isEnum()`                       | boolean |
| `isAnnotation()`          | æ˜¯å¦æ˜¯æ³¨è§£     | `User.class.isAnnotation()`                 | boolean |
| `isPrimitive()`           | æ˜¯å¦æ˜¯åŸºæœ¬ç±»å‹ | `User.class.isPrimitive()`                  | boolean |
| `isAssignableFrom(Class)` | æ˜¯å¦å¯èµ‹å€¼     | `Object.class.isAssignableFrom(User.class)` | boolean |

**è·å–æˆå‘˜æ–¹æ³•**

| æ–¹æ³•                        | è¯´æ˜           | ç¤ºä¾‹                                   | è¿”å›å€¼        |
| --------------------------- | -------------- | -------------------------------------- | ------------- |
| `getFields()`               | è·å–å…¬å…±å­—æ®µ   | `User.class.getFields()`               | Field[]       |
| `getDeclaredFields()`       | è·å–æ‰€æœ‰å­—æ®µ   | `User.class.getDeclaredFields()`       | Field[]       |
| `getMethods()`              | è·å–å…¬å…±æ–¹æ³•   | `User.class.getMethods()`              | Method[]      |
| `getDeclaredMethods()`      | è·å–æ‰€æœ‰æ–¹æ³•   | `User.class.getDeclaredMethods()`      | Method[]      |
| `getConstructors()`         | è·å–å…¬å…±æ„é€ å™¨ | `User.class.getConstructors()`         | Constructor[] |
| `getDeclaredConstructors()` | è·å–æ‰€æœ‰æ„é€ å™¨ | `User.class.getDeclaredConstructors()` | Constructor[] |

```java
// å®Œæ•´æ–¹æ³•ç­¾å
public static Class<?> forName(String className) throws ClassNotFoundException
public static Class<?> forName(String name, boolean initialize, ClassLoader loader) throws ClassNotFoundException

// å‚æ•°è¯´æ˜ï¼š
// 1. className: ç±»çš„å…¨é™å®šåï¼ˆåŒ…å+ç±»åï¼‰
// 2. initialize: æ˜¯å¦åˆå§‹åŒ–ç±»ï¼ˆæ‰§è¡Œstaticå—ï¼‰
// 3. loader: æŒ‡å®šç±»åŠ è½½å™¨

// ä½¿ç”¨ç¤ºä¾‹ï¼š
// åŸºæœ¬ç”¨æ³•
Class<?> userClass1 = Class.forName("com.example.model.User");

// æŒ‡å®šä¸åˆå§‹åŒ–é™æ€å—
Class<?> userClass2 = Class.forName("com.example.model.User", false, 
                                     Thread.currentThread().getContextClassLoader());

// æŒ‡å®šç³»ç»Ÿç±»åŠ è½½å™¨
Class<?> userClass3 = Class.forName("com.example.model.User", true, 
                                     ClassLoader.getSystemClassLoader());


// é€šè¿‡ç±»åŠ è½½å™¨
Class<?> userClass4 = ClassLoader.getSystemClassLoader()
                                 .loadClass("com.example.model.User");
```

**ClassLoaderç›¸å…³æ–¹æ³•**

```java
// é€šè¿‡ç±»åŠ è½½å™¨è·å–Classå¯¹è±¡
ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
Class<?> userClass = classLoader.loadClass("com.example.model.User");

// åŒºåˆ«ï¼š
// 1. Class.forName() ä¼šåˆå§‹åŒ–ç±»ï¼ˆæ‰§è¡Œstaticä»£ç å—ï¼‰
// 2. ClassLoader.loadClass() é»˜è®¤ä¸ä¼šåˆå§‹åŒ–ç±»
// 3. åˆå§‹åŒ–ï¼šä¸ºé™æ€å˜é‡åˆ†é…å†…å­˜å¹¶èµ‹åˆå€¼ï¼Œæ‰§è¡Œstaticå—
```

### â–³ æ„é€ å‡½æ•°æ“ä½œ

Constructorç±»ç”¨äºåˆ›å»ºç±»çš„å®ä¾‹ã€‚
**è·å–æ„é€ å‡½æ•°**

| æ–¹æ³•å                                | æè¿°                                   | è¿”å›ç±»å‹           | ç¤ºä¾‹                                                    |
| ------------------------------------- | -------------------------------------- | ------------------ | ------------------------------------------------------- |
| `getConstructors()`                   | è·å–æ‰€æœ‰å…¬å…±æ„é€ å‡½æ•°                   | `Constructor<?>[]` | `User.class.getConstructors()`                          |
| `getConstructor(Class<?>...)`         | è·å–æŒ‡å®šå‚æ•°ç±»å‹çš„å…¬å…±æ„é€ å‡½æ•°         | `Constructor<T>`   | `User.class.getConstructor(String.class, String.class)` |
| `getDeclaredConstructors()`           | è·å–æ‰€æœ‰æ„é€ å‡½æ•°ï¼ˆåŒ…æ‹¬ç§æœ‰ï¼‰           | `Constructor<?>[]` | `User.class.getDeclaredConstructors()`                  |
| `getDeclaredConstructor(Class<?>...)` | è·å–æŒ‡å®šå‚æ•°ç±»å‹çš„æ„é€ å‡½æ•°ï¼ˆåŒ…æ‹¬ç§æœ‰ï¼‰ | `Constructor<T>`   | `User.class.getDeclaredConstructor()`                   |

**æ“ä½œæ„é€ å‡½æ•°**

| æ–¹æ³•å                   | æè¿°                       | è¿”å›ç±»å‹     | ç¤ºä¾‹                                                      |
| ------------------------ | -------------------------- | ------------ | --------------------------------------------------------- |
| `newInstance(Object...)` | ä½¿ç”¨æ„é€ å‡½æ•°åˆ›å»ºå®ä¾‹       | `T`          | `constructor.newInstance("å¼ ä¸‰", "zhangsan@example.com")` |
| `getParameterTypes()`    | è·å–æ„é€ å‡½æ•°çš„å‚æ•°ç±»å‹æ•°ç»„ | `Class<?>[]` | `constructor.getParameterTypes()`                         |
| `getModifiers()`         | è·å–æ„é€ å‡½æ•°çš„ä¿®é¥°ç¬¦       | `int`        | `constructor.getModifiers()`                              |
| `setAccessible(boolean)` | è®¾ç½®æ„é€ å‡½æ•°çš„å¯è®¿é—®æ€§     | `void`       | `constructor.setAccessible(true)`                         |

```java
import java.lang.reflect.Constructor;

public class ConstructorDemo {
    public static void main(String[] args) throws Exception {
        Class<User> userClass = User.class;
        
        // 1. è·å–æ‰€æœ‰å…¬å…±æ„é€ æ–¹æ³•
        Constructor<?>[] publicConstructors = userClass.getConstructors();
        System.out.println("å…¬å…±æ„é€ æ–¹æ³•æ•°é‡: " + publicConstructors.length);
        
        // 2. è·å–æŒ‡å®šå‚æ•°çš„å…¬å…±æ„é€ æ–¹æ³•
        Constructor<User> stringConstructor = userClass.getConstructor(String.class, String.class);
        System.out.println("è·å–åˆ°(username, email)æ„é€ æ–¹æ³•: " + stringConstructor);
        
        // 3. è°ƒç”¨æ„é€ æ–¹æ³•åˆ›å»ºå®ä¾‹
        User user1 = stringConstructor.newInstance("æå››", "lisi@example.com");
        System.out.println("åå°„åˆ›å»ºçš„ç”¨æˆ·: " + user1);
        
        // 4. è·å–æ— å‚æ„é€ æ–¹æ³•ï¼ˆLombokç”Ÿæˆï¼‰
        Constructor<User> noArgConstructor = userClass.getConstructor();
        User user2 = noArgConstructor.newInstance();
        user2.setUsername("ç‹äº”");
        System.out.println("æ— å‚æ„é€ åˆ›å»ºçš„ç”¨æˆ·: " + user2);
        
        // 5. è·å–æ‰€æœ‰æ„é€ æ–¹æ³•ï¼ˆåŒ…æ‹¬ç§æœ‰ï¼‰
        Constructor<?>[] allConstructors = userClass.getDeclaredConstructors();
        System.out.println("\næ‰€æœ‰æ„é€ æ–¹æ³•åˆ—è¡¨:");
        for (Constructor<?> constructor : allConstructors) {
            System.out.println("  " + constructor);
        }
        
        //ä½¿ç”¨ç§æœ‰æ„é€ éœ€è¦è®¾ç½®setAccessible(true)å…è®¸ä½¿ç”¨private
			Constructor<User> constructor = userClass.getDeclaredConstructor(
                String.class,
                String.class,
                String.class
        );
        constructor.setAccessible(true);
        User user = constructor.newInstance("å¼ ä¸‰", "123", "123");
        System.out.println(user);
    }
}

```

### â–³ æ“ä½œå­—æ®µï¼ˆFieldï¼‰

é€šè¿‡Fieldç±»å¯ä»¥è®¿é—®å’Œä¿®æ”¹ç±»çš„å­—æ®µï¼ŒåŒ…æ‹¬ç§æœ‰å­—æ®µã€‚
**è®¿é—®æ§åˆ¶æ–¹æ³•**

| æ–¹æ³•                     | è¯´æ˜           | ç¤ºä¾‹                        | è¿”å›å€¼  |
| ------------------------ | -------------- | --------------------------- | ------- |
| `setAccessible(boolean)` | è®¾ç½®å¯è®¿é—®æ€§   | `field.setAccessible(true)` | void    |
| `isAccessible()`         | æ£€æŸ¥æ˜¯å¦å¯è®¿é—® | `field.isAccessible()`      | boolean |

**è·å–å­—æ®µä¿¡æ¯**

| æ–¹æ³•                  | è¯´æ˜           | ç¤ºä¾‹                        | è¿”å›å€¼  |
| --------------------- | -------------- | --------------------------- | ------- |
| `getName()`           | è·å–å­—æ®µå     | `field.getName()`           | String  |
| `getType()`           | è·å–å­—æ®µç±»å‹   | `field.getType()`           | Class   |
| `getGenericType()`    | è·å–æ³›å‹ç±»å‹   | `field.getGenericType()`    | Type    |
| `getModifiers()`      | è·å–ä¿®é¥°ç¬¦     | `field.getModifiers()`      | int     |
| `getDeclaringClass()` | è·å–å£°æ˜ç±»     | `field.getDeclaringClass()` | Class   |
| `isEnumConstant()`    | æ˜¯å¦æ˜¯æšä¸¾å¸¸é‡ | `field.isEnumConstant()`    | boolean |
| `isSynthetic()`       | æ˜¯å¦æ˜¯åˆæˆå­—æ®µ | `field.isSynthetic()`       | boolean |

**æ³¨è§£ç›¸å…³æ–¹æ³•**

| æ–¹æ³•                         | è¯´æ˜           | ç¤ºä¾‹                                       | è¿”å›å€¼       |
| ---------------------------- | -------------- | ------------------------------------------ | ------------ |
| `getAnnotations()`           | è·å–æ‰€æœ‰æ³¨è§£   | `field.getAnnotations()`                   | Annotation[] |
| `getAnnotation(Class)`       | è·å–æŒ‡å®šæ³¨è§£   | `field.getAnnotation(NotNull.class)`       | Annotation   |
| `isAnnotationPresent(Class)` | æ˜¯å¦æœ‰æŒ‡å®šæ³¨è§£ | `field.isAnnotationPresent(NotNull.class)` | boolean      |
| `getDeclaredAnnotations()`   | è·å–å£°æ˜æ³¨è§£   | `field.getDeclaredAnnotations()`           | Annotation[] |

**è·å–å­—æ®µçš„æ–¹æ³•**

```java
import java.lang.reflect.Field;
import java.time.LocalDateTime;
import java.util.Arrays;

public class FieldDemo {
    public static void main(String[] args) throws Exception {
        User user = User.builder()
                .username("testuser")
                .email("test@example.com")
                .age(25)
                .score(95.5)
                .active(true)
                .verified(true)
                .createTime(LocalDateTime.now())
                .roles(Arrays.asList("ADMIN", "USER"))
                .gender(User.Gender.MALE)
                .build();
        
        Class<?> userClass = user.getClass();
        
        // 1. è·å–æ‰€æœ‰å…¬å…±å­—æ®µ
        Field[] publicFields = userClass.getFields();
        System.out.println("å…¬å…±å­—æ®µæ•°é‡: " + publicFields.length);
        
        // 2. è·å–æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬ç§æœ‰ï¼‰
        Field[] allFields = userClass.getDeclaredFields();
        System.out.println("\næ‰€æœ‰å­—æ®µåˆ—è¡¨:");
        for (Field field : allFields) {
            System.out.printf("  å­—æ®µå: %-15s ç±»å‹: %-20s ä¿®é¥°ç¬¦: %s\n",
                    field.getName(), field.getType().getSimpleName(), 
                    field.getModifiers());
        }
        
        // 3. è·å–å¹¶æ“ä½œå…¬å…±å­—æ®µ
        Field usernameField = userClass.getDeclaredField("username");
        System.out.println("\nåŸusername: " + usernameField.get(user));
        usernameField.set(user, "newusername");
        System.out.println("ä¿®æ”¹åusername: " + user.getUsername());
        
        // 4. æ“ä½œç§æœ‰å­—æ®µï¼ˆéœ€è¦è®¾ç½®accessibleä¸ºtrueï¼‰
        Field idField = userClass.getDeclaredField("id");
        idField.setAccessible(true);  // çªç ´ç§æœ‰è®¿é—®é™åˆ¶
        idField.set(user, 1001L);
        System.out.println("è®¾ç½®çš„ç§æœ‰å­—æ®µid: " + user.getId());
        
        // 5. æ“ä½œåŸºæœ¬ç±»å‹å­—æ®µ
        Field ageField = userClass.getDeclaredField("age");
        ageField.setAccessible(true);
        System.out.println("åŸage: " + ageField.getInt(user));
        ageField.setInt(user, 30);
        System.out.println("ä¿®æ”¹åage: " + user.getAge());
        
        // 6. æ“ä½œé™æ€å­—æ®µ
        Field defaultRoleField = userClass.getDeclaredField("DEFAULT_ROLE");
        System.out.println("é™æ€å¸¸é‡DEFAULT_ROLE: " + defaultRoleField.get(null));
        
        // 7. æ“ä½œæšä¸¾å­—æ®µ
        Field genderField = userClass.getDeclaredField("gender");
        genderField.setAccessible(true);
        System.out.println("æšä¸¾gender: " + genderField.get(user));
    }
}
```

### â–³ æ–¹æ³•ï¼ˆMethodï¼‰æ“ä½œ

**è·å–æ–¹æ³•ä¿¡æ¯**

| æ–¹æ³•                     | è¯´æ˜             | ç¤ºä¾‹                            | è¿”å›å€¼  |
| ------------------------ | ---------------- | ------------------------------- | ------- |
| `getName()`              | è·å–æ–¹æ³•å       | `method.getName()`              | String  |
| `getReturnType()`        | è·å–è¿”å›ç±»å‹     | `method.getReturnType()`        | Class   |
| `getGenericReturnType()` | è·å–æ³›å‹è¿”å›ç±»å‹ | `method.getGenericReturnType()` | Type    |
| `getModifiers()`         | è·å–ä¿®é¥°ç¬¦       | `method.getModifiers()`         | int     |
| `getDeclaringClass()`    | è·å–å£°æ˜ç±»       | `method.getDeclaringClass()`    | Class   |
| `isBridge()`             | æ˜¯å¦æ˜¯æ¡¥æ¥æ–¹æ³•   | `method.isBridge()`             | boolean |
| `isSynthetic()`          | æ˜¯å¦æ˜¯åˆæˆæ–¹æ³•   | `method.isSynthetic()`          | boolean |
| `isDefault()`            | æ˜¯å¦æ˜¯é»˜è®¤æ–¹æ³•   | `method.isDefault()`            | boolean |
| `isVarArgs()`            | æ˜¯å¦æ˜¯å¯å˜å‚æ•°   | `method.isVarArgs()`            | boolean |

**å‚æ•°ä¿¡æ¯æ–¹æ³•**

| æ–¹æ³•                         | è¯´æ˜              | ç¤ºä¾‹                                | è¿”å›å€¼      |
| ---------------------------- | ----------------- | ----------------------------------- | ----------- |
| `getParameterTypes()`        | è·å–å‚æ•°ç±»å‹      | `method.getParameterTypes()`        | Class[]     |
| `getParameterCount()`        | è·å–å‚æ•°æ•°é‡      | `method.getParameterCount()`        | int         |
| `getParameters()`            | è·å–Parameterå¯¹è±¡ | `method.getParameters()`            | Parameter[] |
| `getGenericParameterTypes()` | è·å–æ³›å‹å‚æ•°ç±»å‹  | `method.getGenericParameterTypes()` | Type[]      |

**å¼‚å¸¸ä¿¡æ¯æ–¹æ³•**

| æ–¹æ³•                         | è¯´æ˜             | ç¤ºä¾‹                                | è¿”å›å€¼  |
| ---------------------------- | ---------------- | ----------------------------------- | ------- |
| `getExceptionTypes()`        | è·å–å¼‚å¸¸ç±»å‹     | `method.getExceptionTypes()`        | Class[] |
| `getGenericExceptionTypes()` | è·å–æ³›å‹å¼‚å¸¸ç±»å‹ | `method.getGenericExceptionTypes()` | Type[]  |

**æ–¹æ³•è°ƒç”¨**

| æ–¹æ³•                         | è¯´æ˜           | ç¤ºä¾‹                                         | è¿”å›å€¼         |
| ---------------------------- | -------------- | -------------------------------------------- | -------------- |
| `getAnnotations()`           | è·å–æ‰€æœ‰æ³¨è§£   | `method.getAnnotations()`                    | Annotation[]   |
| `getAnnotation(Class)`       | è·å–æŒ‡å®šæ³¨è§£   | `method.getAnnotation(Override.class)`       | Annotation     |
| `isAnnotationPresent(Class)` | æ˜¯å¦æœ‰æŒ‡å®šæ³¨è§£ | `method.isAnnotationPresent(Override.class)` | boolean        |
| `getDeclaredAnnotations()`   | è·å–å£°æ˜æ³¨è§£   | `method.getDeclaredAnnotations()`            | Annotation[]   |
| `getParameterAnnotations()`  | è·å–å‚æ•°æ³¨è§£   | `method.getParameterAnnotations()`           | Annotation[][] |

```java
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;

public class MethodDemo {
    public static void main(String[] args) throws Exception {
        User user = User.builder()
                .username("methoduser")
                .email("method@example.com")
                .age(20)
                .nickname("æ˜µç§°")
                .build();
        
        Class<?> userClass = user.getClass();
        
        // 1. è·å–æ‰€æœ‰å…¬å…±æ–¹æ³•ï¼ˆåŒ…æ‹¬ç»§æ‰¿çš„ï¼‰
        Method[] publicMethods = userClass.getMethods();
        System.out.println("å…¬å…±æ–¹æ³•æ€»æ•°: " + publicMethods.length);
        System.out.println("å‰5ä¸ªå…¬å…±æ–¹æ³•:");
        for (int i = 0; i < Math.min(5, publicMethods.length); i++) {
            System.out.println("  " + publicMethods[i]);
        }
        
        // 2. è·å–æ‰€æœ‰å£°æ˜çš„æ–¹æ³•ï¼ˆä¸åŒ…æ‹¬ç»§æ‰¿çš„ï¼‰
        Method[] declaredMethods = userClass.getDeclaredMethods();
        System.out.println("\nUserç±»å£°æ˜çš„æ–¹æ³•åˆ—è¡¨:");
        for (Method method : declaredMethods) {
            String modifier = Modifier.toString(method.getModifiers());
            System.out.printf("  %-20s %s\n", modifier, method.getName());
        }
        
        // 3. è°ƒç”¨å…¬å…±æ–¹æ³•
        Method getDisplayNameMethod = userClass.getDeclaredMethod("getDisplayName");
        Object result = getDisplayNameMethod.invoke(user);
        System.out.println("\nè°ƒç”¨getDisplayName(): " + result);
        
        Method isAdultMethod = userClass.getDeclaredMethod("isAdult");
        boolean isAdult = (boolean) isAdultMethod.invoke(user);
        System.out.println("è°ƒç”¨isAdult(): " + isAdult);
        
        // 4. è°ƒç”¨ç§æœ‰æ–¹æ³•
        Method privateMethod = userClass.getDeclaredMethod("privateMethod");
        privateMethod.setAccessible(true);
        System.out.print("è°ƒç”¨ç§æœ‰æ–¹æ³•privateMethod(): ");
        privateMethod.invoke(user);
        
        // 5. è°ƒç”¨é™æ€æ–¹æ³•
        Method createDefaultMethod = userClass.getDeclaredMethod("createDefault");
        User defaultUser = (User) createDefaultMethod.invoke(null);
        System.out.println("\nè°ƒç”¨é™æ€æ–¹æ³•createDefault(): " + defaultUser);
        
        // 6. è°ƒç”¨å¸¦å‚æ•°çš„æ–¹æ³•ï¼ˆç¤ºä¾‹ï¼šsetteræ–¹æ³•ï¼‰
        Method setAgeMethod = userClass.getMethod("setAge", int.class);
        setAgeMethod.invoke(user, 35);
        System.out.println("é€šè¿‡åå°„è®¾ç½®ageå: " + user.getAge());
    }
}
```

### â–³ æ“ä½œæ³›å‹ä¸æšä¸¾

**æ³›å‹æ“ä½œ**

```java
public class ReflectionGenericDemo {
    public static void main(String[] args) throws Exception {
        Class<User> userClass = User.class;
        User user = new User();
        
        // è·å–List<String> roleså­—æ®µ
        Field rolesField = userClass.getDeclaredField("roles");
        rolesField.setAccessible(true);
        
        // è·å–æ³›å‹ç±»å‹ä¿¡æ¯
        Type genericType = rolesField.getGenericType();
        if (genericType instanceof ParameterizedType) {
            ParameterizedType paramType = (ParameterizedType) genericType;
            Type[] typeArgs = paramType.getActualTypeArguments();
            System.out.println("roleså­—æ®µçš„æ³›å‹ç±»å‹: " + typeArgs[0]);  // class java.lang.String
        }
        
        // åˆ›å»ºArrayListå¹¶è®¾ç½®å€¼
        List<String> roles = new ArrayList<>();
        roles.add("ADMIN");
        roles.add("USER");
        rolesField.set(user, roles);
        
        // è·å–å¹¶éå†
        List<String> userRoles = (List<String>) rolesField.get(user);
        System.out.println("ç”¨æˆ·è§’è‰²: " + userRoles);
    }
}
```

**æ“ä½œæšä¸¾**

```java
public class ReflectionEnumDemo {
    public static void main(String[] args) throws Exception {
        Class<User> userClass = User.class;
        
        // 1. è·å–æšä¸¾ç±»
        Class<?> genderEnumClass = Class.forName("com.example.model.User$Gender");
        
        // 2. è·å–æ‰€æœ‰æšä¸¾å€¼
        Object[] enumValues = genderEnumClass.getEnumConstants();
        System.out.println("Genderæšä¸¾å€¼:");
        for (Object value : enumValues) {
            System.out.println(value);
        }
        // è¾“å‡ºï¼šMALE, FEMALE, UNKNOWN
        
        // 3. åˆ›å»ºå¸¦æšä¸¾çš„Userå¯¹è±¡
        User user = new User();
        
        // è·å–æšä¸¾å­—æ®µ
        Field genderField = userClass.getDeclaredField("gender");
        genderField.setAccessible(true);
        
        // è·å–ç‰¹å®šçš„æšä¸¾å€¼
        Method valueOfMethod = genderEnumClass.getMethod("valueOf", String.class);
        Object maleEnum = valueOfMethod.invoke(null, "MALE");
        
        // è®¾ç½®æšä¸¾å€¼
        genderField.set(user, maleEnum);
        System.out.println("\nç”¨æˆ·æ€§åˆ«: " + user.getGender());
    }
}
```

## â—‹ åå°„åº•å±‚åŸç†æœºåˆ¶

### â–³ ç±»åŠ è½½æœºåˆ¶

**ç±»çš„ç”Ÿå‘½å‘¨æœŸï¼šä»å­—èŠ‚ç åˆ°å¯ç”¨çš„ç±»**
æƒ³è±¡ä½ ç½‘è´­äº†ä¸€ä»¶å®¶å…·ï¼ˆ`.class`æ–‡ä»¶ï¼‰ï¼Œä»ä¸‹å•åˆ°ä½¿ç”¨ï¼Œç»å†è¿™æ ·çš„è¿‡ç¨‹ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/28b13c9f640f42959e446f21bd175af6.png)

| é˜¶æ®µ       | åšäº†ä»€ä¹ˆ                               | ç”Ÿæ´»ç±»æ¯”                           |
| ---------- | -------------------------------------- | ---------------------------------- |
| **åŠ è½½**   | è¯»å–.classå­—èŠ‚æµï¼Œåˆ›å»ºClasså¯¹è±¡        | å¿«é€’å‘˜æŠŠåŒ…è£¹é€åˆ°å®¶é—¨å£             |
| **éªŒè¯**   | æ£€æŸ¥å­—èŠ‚ç æ ¼å¼ã€è¯­ä¹‰æ˜¯å¦åˆæ³•           | å¼€ç®±æ£€æŸ¥å®¶å…·æœ‰æ²¡æœ‰æŸåã€é›¶ä»¶é½ä¸é½ |
| **å‡†å¤‡**   | ä¸ºé™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œèµ‹é»˜è®¤å€¼ï¼ˆ0/nullï¼‰ | åœ¨æˆ¿é—´é‡Œè…¾å‡ºæ”¾å®¶å…·çš„ä½ç½®           |
| **è§£æ**   | å°†ç¬¦å·å¼•ç”¨è½¬ä¸ºç›´æ¥å¼•ç”¨                 | æŠŠè¯´æ˜ä¹¦ä¸Šçš„é›¶ä»¶ç¼–å·å¯¹åº”åˆ°å®é™…é›¶ä»¶ |
| **åˆå§‹åŒ–** | æ‰§è¡Œé™æ€ä»£ç å—ï¼Œèµ‹çœŸæ­£åˆå§‹å€¼           | æ­£å¼ç»„è£…å®¶å…·å¹¶æŠ•å…¥ä½¿ç”¨             |

**ç±»åŠ è½½çš„äº”ä¸ªæ ¸å¿ƒé˜¶æ®µ**

**é˜¶æ®µ1**ï¼šåŠ è½½ï¼ˆLoadingï¼‰
è¿™æ˜¯åå°„çš„ç”Ÿå‘½èµ·ç‚¹ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒJVMå®Œæˆä¸‰ä»¶äº‹ï¼š
æ‰¾åˆ°å­—èŠ‚ç ï¼šæ ¹æ®ç±»åï¼ˆå¦‚com.example.Studentï¼‰æ‰¾åˆ°å¯¹åº”çš„.classæ–‡ä»¶
è¯»å–å†…å®¹ï¼šæŠŠæ–‡ä»¶å†…å®¹è¯»æˆäºŒè¿›åˆ¶æ•°æ®æµ
åˆ›å»ºClasså¯¹è±¡ï¼šåœ¨å †å†…å­˜ä¸­ç”Ÿæˆè¯¥ç±»çš„Classå¯¹è±¡
ä¸€ä¸ªç±»åªä¼šè¢«åŠ è½½ä¸€æ¬¡ï¼Œæ‰€ä»¥Classå¯¹è±¡åœ¨JVMä¸­å…¨å±€å”¯ä¸€

**é˜¶æ®µ2**ï¼šéªŒè¯ï¼ˆVerificationï¼‰
JVMéå¸¸è°¨æ…ï¼Œå®ƒè¦ç¡®ä¿å­—èŠ‚ç æ˜¯å®‰å…¨çš„ã€åˆæ³•çš„ï¼š
æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆæ˜¯ä¸æ˜¯æ­£ç»çš„.classæ–‡ä»¶ï¼‰
æ£€æŸ¥æ˜¯å¦æœ‰éæ³•æŒ‡ä»¤
æ£€æŸ¥æ˜¯å¦ç¬¦åˆJavaè¯­æ³•è§„èŒƒ
è¿™ä¸ªé˜¶æ®µå¦‚æœå‡ºé”™ï¼Œä¼šæŠ›å‡ºVerifyError3ã€‚

**é˜¶æ®µ3**ï¼šå‡†å¤‡ï¼ˆPreparationï¼‰
ä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ï¼Œå¹¶è®¾ç½®é»˜è®¤å€¼ï¼ˆä¸æ˜¯ä»£ç é‡Œå†™çš„å€¼ï¼ï¼‰

```java
// ä»£ç ä¸­è¿™æ ·å†™
public static int count = 100;

// å‡†å¤‡é˜¶æ®µï¼šç»™countåˆ†é…å†…å­˜ï¼Œèµ‹å€¼ä¸º0ï¼ˆintçš„é»˜è®¤å€¼ï¼‰
// çœŸæ­£çš„èµ‹å€¼100å‘ç”Ÿåœ¨åˆå§‹åŒ–é˜¶æ®µ
```

ç‰¹æ®Šä¾‹å¤–ï¼šå¦‚æœå˜é‡æ˜¯static finalå¸¸é‡ï¼Œå‡†å¤‡é˜¶æ®µç›´æ¥èµ‹çœŸå®å€¼ï¼š

```java
public static final int MAX_SIZE = 1024;  // å‡†å¤‡é˜¶æ®µç›´æ¥èµ‹å€¼ä¸º1024
```

**é˜¶æ®µ4**ï¼šè§£æï¼ˆResolutionï¼‰
æŠŠä»£ç ä¸­çš„"ç¬¦å·å¼•ç”¨"ï¼ˆå¦‚Student.nameï¼‰è½¬æ¢æˆJVMå†…å­˜ä¸­çš„"ç›´æ¥å¼•ç”¨"ï¼ˆå†…å­˜åœ°å€ï¼‰

**é˜¶æ®µ5**ï¼šåˆå§‹åŒ–ï¼ˆInitializationï¼‰
çœŸæ­£æ‰§è¡Œç±»ä¸­çš„é™æ€ä»£ç ï¼š

```java
public class Student {
    static {
        System.out.println("Studentç±»åˆå§‹åŒ–äº†ï¼");  // è¿™é‡Œæ‰§è¡Œ
    }
    public static int count = 100;  // è¿™é‡Œèµ‹å€¼ä¸º100
}
```

åœ¨åˆå§‹åŒ–å®Œæˆåä¼šåœ¨æ–¹æ³•åŒºç”ŸæˆclassäºŒè¿›åˆ¶æ•°æ®
ä¼šåœ¨å †å†…ç”ŸæˆClasså®ä¾‹å¯¹è±¡å¯¹åº”ç±»çš„classæ¨¡æ¿å¯¹è±¡

**åŒäº²å§”æ´¾æ¨¡å‹çš„å·¥ä½œæµç¨‹**

```java
// ä¼ªä»£ç ï¼šClassLoader.loadClass() çš„æ ¸å¿ƒé€»è¾‘
protected Class<?> loadClass(String name) {
    // 1. å…ˆæ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼ˆç¼“å­˜ï¼‰
    Class<?> c = findLoadedClass(name);
    if (c == null) {
        // 2. å§”æ´¾ç»™çˆ¶åŠ è½½å™¨ï¼ˆå±‚å±‚ä¸ŠæŠ¥ï¼‰
        if (parent != null) {
            c = parent.loadClass(name);  // é€’å½’å‘ä¸Š
        } else {
            c = findBootstrapClass(name); // åˆ°é¡¶äº†ï¼Œé—®Bootstrap
        }
        // 3. çˆ¶åŠ è½½å™¨åŠ è½½å¤±è´¥ï¼Œè‡ªå·±æ‰å°è¯•åŠ è½½
        if (c == null) {
            c = findClass(name);  // è‡ªå·±å¹²æ´»
        }
    }
    return c;
}
```

æºç ï¼š

```java
protected Class<?> loadClass(String name, boolean resolve)
        throws ClassNotFoundException
    {
        synchronized (getClassLoadingLock(name)) {
            // First, check if the class has already been loaded
            Class<?> c = findLoadedClass(name);
            if (c == null) {
                long t0 = System.nanoTime();
                try {
                    if (parent != null) {
                        c = parent.loadClass(name, false);
                    } else {
                        c = findBootstrapClassOrNull(name);
                    }
                } catch (ClassNotFoundException e) {
                    // ClassNotFoundException thrown if class not found
                    // from the non-null parent class loader
                }

                if (c == null) {
                    // If still not found, then invoke findClass in order
                    // to find the class.
                    long t1 = System.nanoTime();
                    c = findClass(name);

                    // this is the defining class loader; record the stats
                    PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                    PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                    PerfCounter.getFindClasses().increment();
                }
            }
            if (resolve) {
                resolveClass(c);
            }
            return c;
        }
    }
```

**Classå¦‚ä½•å˜ä¸ºJVMçš„å†…éƒ¨æ•°æ®**
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/4005f79689f643e89518d62508929e4b.png)

1. **InstanceKlass**ï¼ˆC++å±‚é¢ï¼‰ï¼šå­˜å‚¨ç±»çš„å®Œæ•´å…ƒæ•°æ®ï¼Œåœ¨æ–¹æ³•åŒº/å…ƒç©ºé—´
2. **Classå¯¹è±¡**ï¼ˆJavaå±‚é¢ï¼‰ï¼šInstanceKlassçš„Javaé•œåƒï¼Œä¾›åå°„APIä½¿ç”¨

### â–³ Classå¯¹è±¡

**Classå¯¹è±¡çš„æœ¬è´¨ï¼šç±»çš„"èº«ä»½è¯"**
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/f1604791de3841af962c657b2d0b7af3.png)

åœ¨Javaä¸–ç•Œé‡Œï¼Œæ¯ä¸ªç±»ï¼ˆåŒ…æ‹¬Stringã€ArrayListï¼‰éƒ½æ˜¯java.lang.Classç±»çš„ä¸€ä¸ªå®ä¾‹å¯¹è±¡ã€‚

æ›´å‡†ç¡®åœ°è¯´ï¼šæ¯ä¸ªç±»åœ¨å †å†…å­˜ä¸­éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„Classå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯è¯¥ç±»çš„"èº«ä»½è¯"ã€‚

```java
// è¿™ä¸‰ä¸ªClasså¯¹è±¡æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼
Class<?> c1 = Student.class;
Class<?> c2 = new Student().getClass();
Class<?> c3 = Class.forName("com.example.Student");

System.out.println(c1 == c2);  // true
System.out.println(c1 == c3);  // true
```

**Classå¯¹è±¡åˆ›å»ºï¼ˆJVMç‹¬å®¶å„æ–­ï¼‰**
Classç±»çš„æ„é€ æ–¹æ³•ï¼š

```java
private Class(ClassLoader loader, Class<?> arrayComponentType) {
        // Initialize final field for classLoader.  The initialization value of non-null
        // prevents future JIT optimizations from assuming this final field is null.
        classLoader = loader;
        componentType = arrayComponentType;
    }
```

JVMé€šè¿‡è¿™ç§æ–¹å¼ä¿è¯ï¼šä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªClasså¯¹è±¡ã€‚å¦‚æœå…è®¸éšæ„åˆ›å»ºï¼Œå°±ä¼šå‡ºç°å¤šä¸ªClasså¯¹è±¡å¯¹åº”åŒä¸€ä¸ªç±»ï¼Œæ•°æ®å°±ä¹±å¥—äº†ã€‚

**Classå¯¹è±¡èƒ½åšä»€ä¹ˆï¼Ÿ**
Classå¯¹è±¡å°±åƒç±»çš„"æ§åˆ¶é¢æ¿"ï¼Œæä¾›äº†æ‰€æœ‰æ“ä½œæ¥å£ï¼š

```java
public class Class<T> {
    // 1. è·å–ç±»çš„åŸºæœ¬ä¿¡æ¯
    String getName();      // å…¨é™å®šåï¼šcom.example.Student
    String getSimpleName(); // ç®€å•åï¼šStudent
    
    // 2. è·å–ç±»çš„æˆå‘˜ï¼ˆåå°„çš„æ ¸å¿ƒï¼‰
    Field getDeclaredField(String name);      // è·å–å±æ€§ï¼ˆåŒ…æ‹¬ç§æœ‰ï¼‰
    Method getDeclaredMethod(String name, Class<?>... params); // è·å–æ–¹æ³•
    Constructor<T> getDeclaredConstructor(Class<?>... params); // è·å–æ„é€ å™¨
    
    // 3. åˆ›å»ºå¯¹è±¡
    T newInstance();  // è¿‡æ—¶æ–¹æ³•ï¼Œæ¨èç”¨æ„é€ å™¨
    
    // 4. ç±»å‹åˆ¤æ–­
    boolean isInstance(Object obj);  // objæ˜¯ä¸æ˜¯è¿™ä¸ªç±»çš„å®ä¾‹
}
```

### â–³ åå°„åº•å±‚åŸç†

äº†è§£å®Œç±»åŠ è½½æœºåˆ¶ä¸Classå¯¹è±¡åå¼€å§‹è¯¦è§£åå°„åº•å±‚çš„æœºåˆ¶åŸç†

**æ ¹æ®Classéƒ¨åˆ†æºç æ¥ç†è§£Class.forName()åº•å±‚æœºåˆ¶ï¼š**

```java
public final class Class<T> implements Serializable, GenericDeclaration, 
                                        Type, AnnotatedElement {
    // ========== æ ¸å¿ƒå…ƒæ•°æ®ç¼“å­˜ ==========
    private transient String name;           // ç±»å
    private transient Module module;         // æ‰€å±æ¨¡å—(Java9+)
    
    // åå°„æ•°æ®çš„è½¯å¼•ç”¨ç¼“å­˜ï¼ˆæŒ‰éœ€åŠ è½½ï¼Œé¿å…å†…å­˜æµªè´¹ï¼‰
    private transient volatile SoftReference<ReflectionData<T>> reflectionData;
    
    // ReflectionDataå†…éƒ¨ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š
    // static class ReflectionData<T> {
    //     volatile Field[] declaredFields;      // å£°æ˜çš„å­—æ®µ
    //     volatile Field[] publicFields;        // å…¬å¼€å­—æ®µ
    //     volatile Method[] declaredMethods;    // å£°æ˜çš„æ–¹æ³•  
    //     volatile Method[] publicMethods;      // å…¬å¼€æ–¹æ³•
    //     volatile Constructor<T>[] declaredConstructors; // æ„é€ å™¨
    //     ...
    // }
    
    private transient volatile T[] enumConstants;    // æšä¸¾å¸¸é‡
    private transient volatile Map<String, T> enumConstantDirectory;
    private transient volatile AnnotationData annotationData; // æ³¨è§£
    
    // ========== nativeæ–¹æ³•ï¼šé€šå¾€JVMçš„æ¡¥æ¢ ==========
    private native Field[] getDeclaredFields0(boolean publicOnly);
    private native Method[] getDeclaredMethods0(boolean publicOnly);
    private native Constructor<T>[] getDeclaredConstructors0(boolean publicOnly);
}
```

**è¿™è¡Œä»£ç åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ**

```java
Class<?> clazz = Class.forName("com.example.User");
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/bf64cb6c9d464785a01ea6af12a98a54.png)
**`getMethod()` / `getField()` å¦‚ä½•æŸ¥è¯¢å…ƒæ•°æ®**

```java
Method method = clazz.getMethod("setName", String.class);
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/604d413a281944149ceb09e51d3254c1.png)
**æºç ç®€åŒ–ç‰ˆï¼š**

```java
private Method[] privateGetDeclaredMethods(boolean publicOnly) {
    Method[] res;
    ReflectionData<T> rd = reflectionData();
    if (rd != null) {
        res = publicOnly ? rd.publicMethods : rd.declaredMethods;
        if (res != null) return res;
    }
    // ç¼“å­˜æœªå‘½ä¸­ï¼Œè°ƒç”¨native
    res = getDeclaredMethods0(publicOnly);  // çœŸæ­£å»JVMå–æ•°æ®
    // å­˜å…¥ç¼“å­˜...
    return res;
}
```

### â–³ Invokeçš„åº•å±‚

```java
Method method = User.class.getMethod("setName", String.class);
method.invoke(userInstance, "å¼ ä¸‰");  // åº•å±‚å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ
```

Method.invoke() çš„å†…éƒ¨æœºåˆ¶ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/7daac7085bb84a849377ac4bf0d6a9f6.png)
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/5b2f502cbdec4674b1a845ac8d152648.png)
**åŠ¨æ€ç”Ÿæˆçš„å­—èŠ‚ç **

```java
// JVMåŠ¨æ€ç”Ÿæˆçš„ç±»ï¼Œç­‰ä»·äºï¼š
public class GeneratedMethodAccessor1 extends MethodAccessorImpl {
    public Object invoke(Object obj, Object[] args) {
        // ç›´æ¥è°ƒç”¨ï¼æ²¡æœ‰ä»»ä½•åå°„å¼€é”€
        ((User) obj).setName((String) args[0]);
        return null;
    }
}
```

**NativeMethodAccessorImplï¼šåå°„çš„"æ…¢é€Ÿé€šé“"**
å½“invokeè°ƒç”¨æ–¹æ³•åœ¨1-15æ¬¡å†…ä½¿ç”¨ï¼š

```java
// NativeMethodAccessorImplçš„ç®€åŒ–æºç ï¼ˆOpenJDKï¼‰
public class NativeMethodAccessorImpl extends MethodAccessorImpl {
    private final Method method;
    private int numInvocations;  // è°ƒç”¨è®¡æ•°å™¨
    
    public Object invoke(Object obj, Object[] args) throws ... {
        // é˜ˆå€¼æ£€æŸ¥ï¼šé»˜è®¤15æ¬¡
        if (++numInvocations > ReflectionFactory.inflationThreshold()) {
            // è¾¾åˆ°é˜ˆå€¼ï¼Œåˆ›å»ºä¼˜åŒ–çš„å­—èŠ‚ç ç‰ˆæœ¬
            MethodAccessorImpl acc = (MethodAccessorImpl)
                new MethodAccessorGenerator()
                    .generateMethod(method.getDeclaringClass(),
                                  method.getName(),
                                  method.getParameterTypes(),
                                  method.getReturnType(),
                                  method.getExceptionTypes(),
                                  method.getModifiers());
            // æ›¿æ¢å½“å‰çš„è®¿é—®å™¨
            parent.setDelegate(acc);
            // ä½¿ç”¨æ–°ç”Ÿæˆçš„è®¿é—®å™¨æ‰§è¡Œæœ¬æ¬¡è°ƒç”¨
            return acc.invoke(obj, args);
        }
        
        // æœªè¾¾é˜ˆå€¼ï¼Œä½¿ç”¨nativeè°ƒç”¨
        return invoke0(method, obj, args);  // â† JNIè°ƒç”¨ï¼
    }
    
    private static native Object invoke0(Method m, Object obj, Object[] args);
}
```

**è¿™ä¸ªnativeè°ƒç”¨ï¼ˆinvoke0ï¼‰åšäº†ä»€ä¹ˆ**

 - JNIè¾¹ç•Œè·¨è¶Šï¼šä»Javaå±‚è¿›å…¥JVMçš„C++å±‚
 - å‚æ•°å¤„ç†ï¼šå°†Objectæ•°ç»„ä¸­çš„å‚æ•°æŒ‰éœ€æ‹†ç®±ã€ç±»å‹è½¬æ¢
 - å®‰å…¨æ£€æŸ¥ï¼šæ£€æŸ¥è®¿é—®æƒé™ï¼ˆé™¤ésetAccessible(true)ï¼‰
 - æ–¹æ³•åˆ†æ´¾ï¼šé€šè¿‡vtableï¼ˆè™šæ–¹æ³•è¡¨ï¼‰æ‰¾åˆ°å®é™…æ–¹æ³•åœ°å€
 - æ ˆå¸§è®¾ç½®ï¼šåˆ›å»ºæ–°çš„æ ˆå¸§ï¼Œè®¾ç½®å‚æ•°
 - æ–¹æ³•æ‰§è¡Œï¼šè·³è½¬åˆ°æ–¹æ³•ä»£ç å¼€å§‹æ‰§è¡Œ
 - ä¸ºä»€ä¹ˆè¿™ä¹ˆæ…¢ï¼Ÿ
   æ¯æ¬¡è°ƒç”¨éƒ½è¦ç»å†å®Œæ•´çš„JNIå¼€é”€ï¼Œç›¸å½“äºæ¯æ¬¡éƒ½è¦"å‡ºå›½æ—…æ¸¸ä¸€åœˆ"ã€‚

**åŠ¨æ€å­—èŠ‚ç ç”ŸæˆGeneratedMethodAccessorï¼šåå°„çš„"é«˜é€Ÿå…¬è·¯"**
å½“è°ƒç”¨æ¬¡æ•°è¾¾åˆ°é˜ˆå€¼ï¼ˆé»˜è®¤15æ¬¡ï¼‰æ—¶ï¼ŒJVMä¼šè§¦å‘"è†¨èƒ€"ï¼ˆInflationï¼‰è¿‡ç¨‹ï¼Œç”Ÿæˆä¼˜åŒ–çš„å­—èŠ‚ç ã€‚

ç”ŸæˆåŠ¨æ€å­—èŠ‚ç ç›¸å½“äºç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„ç±» ä¸‹æ¬¡åå°„è°ƒç”¨æŒ‡å®šæ–¹æ³•æ—¶ç›´æ¥é€šè¿‡è¿™ä¸ªç±»è°ƒç”¨å³å¯ æ¯”åœ¨åº•å±‚å¯»æ‰¾è™šæ–¹æ³•è¡¨å¿«å¤šäº†

```java
// ä¼ªä»£ç ï¼šMethodAccessorGeneratorå¦‚ä½•ç”Ÿæˆå­—èŠ‚ç 
public MethodAccessor generateMethod(Class<?> declaringClass,
                                   String methodName,
                                   Class<?>[] parameterTypes,
                                   Class<?> returnType,
                                   Class<?>[] exceptionTypes,
                                   int modifiers) {
    
    // 1. åˆ›å»ºå­—èŠ‚ç ç”Ÿæˆå™¨
    BytecodeGenerator gen = new BytecodeGenerator();
    
    // 2. ç”Ÿæˆç±»åï¼šsun/reflect/GeneratedMethodAccessorN
    String className = "sun/reflect/GeneratedMethodAccessor" + counter.incrementAndGet();
    
    // 3. ç”Ÿæˆç±»ç»“æ„
    gen.startClass(className, "sun/reflect/MethodAccessorImpl");
    
    // 4. ç”Ÿæˆinvokeæ–¹æ³•
    gen.startMethod("invoke", "(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;");
    
    // 5. ç”Ÿæˆæ–¹æ³•ä½“å­—èŠ‚ç ï¼ˆæ ¸å¿ƒï¼ï¼‰
    // ç›®æ ‡ï¼šç›´æ¥è°ƒç”¨methodï¼Œé¿å…åå°„å¼€é”€
    generateDirectInvocation(gen, declaringClass, methodName, 
                            parameterTypes, returnType);
    
    // 6. å®Œæˆç”Ÿæˆ
    byte[] bytecode = gen.endMethod().endClass();
    
    // 7. å®šä¹‰ç±»å¹¶åŠ è½½
    Class<?> accessorClass = defineClass(bytecode);
    return accessorClass.newInstance();
}
```

**æ€»ç»“Invoke**

 - å…¥å£ï¼šmethod.invoke()è°ƒç”¨
 - å§”æ‰˜ï¼šDelegatingMethodAccessorImplå†³å®šä½¿ç”¨å“ªä¸ªå®ç°
 - åˆå§‹é˜¶æ®µï¼šNativeMethodAccessorImplé€šè¿‡JNIè°ƒç”¨
 - é˜ˆå€¼æ£€æµ‹ï¼šè®¡æ•°è¾¾åˆ°15æ¬¡è§¦å‘ä¼˜åŒ–
 - å­—èŠ‚ç ç”Ÿæˆï¼šMethodAccessorGeneratorç”Ÿæˆç›´æ¥è°ƒç”¨çš„å­—èŠ‚ç 
 - ç±»åŠ è½½ï¼šåŠ¨æ€å®šä¹‰å¹¶åŠ è½½GeneratedMethodAccessorç±»
 - åˆ‡æ¢æ‰§è¡Œï¼šåç»­è°ƒç”¨èµ°ä¼˜åŒ–è·¯å¾„
 - æ€§èƒ½æå‡ï¼šä»~100nsé™åˆ°~10ns

## â—‹ åŠ¨æ€ä»£ç†

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ˜¯ä½æ˜æ˜Ÿï¼ˆçœŸå®å¯¹è±¡ï¼‰ï¼Œæ¯å¤©è¦å¤„ç†å„ç§äº‹åŠ¡ï¼šè¡¨æ¼”ã€é‡‡è®¿ã€å•†åŠ¡æ´½è°ˆã€‚å¦‚æœæ‰€æœ‰äº‹éƒ½äº²åŠ›äº²ä¸ºï¼Œä¸ä»…æ•ˆç‡ä½ï¼Œè¿˜å¯èƒ½å¿™ä¸­å‡ºé”™ã€‚äºæ˜¯ä½ è˜è¯·äº†ä¸€ä½ç»çºªäººï¼ˆä»£ç†å¯¹è±¡ï¼‰ï¼Œä»–å¸®ä½ ç­›é€‰é‚€è¯·ã€å®‰æ’è¡Œç¨‹ã€å¤„ç†æ‚åŠ¡ï¼Œè®©ä½ èƒ½ä¸“æ³¨äºæ ¸å¿ƒä¸šåŠ¡â€”â€”è¡¨æ¼”ã€‚

è¿™å°±æ˜¯ä»£ç†æ¨¡å¼çš„ç²¾é«“ï¼šé€šè¿‡ä¸€ä¸ªä¸­é—´å±‚ï¼ˆä»£ç†ï¼‰æ¥æ§åˆ¶å¯¹åŸå§‹å¯¹è±¡çš„è®¿é—®ã€‚åœ¨Javaä¸­ï¼Œè¿™ä¸ªâ€œç»çºªäººâ€å°±æ˜¯åŠ¨æ€ä»£ç†ï¼Œè€Œå®ƒçš„è¶…èƒ½åŠ›æ¥è‡ªäºåå°„æœºåˆ¶ã€‚

### â–³ é™æ€ä»£ç†

é™æ€ä»£ç†å°±åƒæ˜¯æ‰‹å†™çš„ç»çºªäººåˆåŒã€‚ä½ ï¼ˆç¨‹åºå‘˜ï¼‰éœ€è¦ä¸ºæ¯ä¸ªæ˜æ˜Ÿï¼ˆç±»ï¼‰å•ç‹¬ç¼–å†™ä¸€ä¸ªç»çºªäººï¼ˆä»£ç†ç±»ï¼‰ï¼Œå¹¶ä¸”åœ¨ç¼–è¯‘å‰å°±ç¡®å®šå¥½æ‰€æœ‰ç»†èŠ‚ã€‚

**ä»£ç†çš„æ ¸å¿ƒï¼š**

 - **ç›®æ ‡å¯¹è±¡**ï¼ˆè¢«ä»£ç†å¯¹è±¡ï¼‰ï¼šçœŸæ­£å¹²æ´»çš„äºº / ç±»ï¼Œæ¯”å¦‚ï¼šç§Ÿæˆ¿çš„æˆ¿ä¸œã€å”±æ­Œçš„æ˜æ˜Ÿã€æ‰§è¡Œä¸šåŠ¡é€»è¾‘çš„UserServiceImplï¼›
 - **ä»£ç†å¯¹è±¡**ï¼ˆä¸­é—´äººï¼‰ï¼šæ›¿ç›®æ ‡å¯¹è±¡å¹²æ´»çš„äºº / ç±»ï¼Œæ¯”å¦‚ï¼šç§Ÿæˆ¿ä¸­ä»‹ã€æ˜æ˜Ÿç»çºªäººã€ä»£ç†ç±»$Proxy0ï¼›
 - **å¢å¼ºé€»è¾‘**ï¼šä»£ç†å¯¹è±¡åœ¨æ‰§è¡Œç›®æ ‡æ–¹æ³•æ—¶ï¼Œé¢å¤–åŠ çš„é€»è¾‘ï¼Œæ¯”å¦‚ï¼šä¸­ä»‹æ”¶ä¸­ä»‹è´¹ã€ç»çºªäººå®‰æ’è¡Œç¨‹ã€æ—¥å¿—æ‰“å°ã€äº‹åŠ¡å¼€å¯ / æäº¤ã€‚

**ç‰¹ç‚¹ï¼š**

 - ä»£ç†ç±»éœ€è¦å®ç°ä¸ç›®æ ‡ç±»ç›¸åŒçš„æ¥å£
 - æ¯ä¸ªä»£ç†ç±»åªèƒ½ä¸ºä¸€ä¸ªç‰¹å®šçš„ç›®æ ‡ç±»æœåŠ¡
 - ä»£ç å†—ä½™ï¼Œç»´æŠ¤å›°éš¾ï¼ˆæ˜æ˜Ÿè¶Šå¤šï¼Œç»çºªäººåˆåŒè¶Šå¤šï¼‰

```java
// æ˜æ˜Ÿæ¥å£
public interface Star {
    void perform();
}

// çœŸå®æ˜æ˜Ÿ
public class RealStar implements Star {
    public void perform() {
        System.out.println("æ˜æ˜Ÿåœ¨èˆå°ä¸Šè¡¨æ¼”...");
    }
}

// é™æ€ä»£ç†ï¼šæ‰‹åŠ¨ç¼–å†™çš„ç»çºªäºº
public class StaticProxyStar implements Star {
    private Star realStar;
    
    public StaticProxyStar(Star realStar) {
        this.realStar = realStar;
    }
    
    @Override
    public void perform() {
        System.out.println("ç»çºªäººï¼šå®‰æ’åœºåœ°ã€å”®ç¥¨...");
        realStar.perform();  // æ˜æ˜ŸçœŸæ­£è¡¨æ¼”
        System.out.println("ç»çºªäººï¼šå¤„ç†åç»­äº‹å®œ...");
    }
}
```

é—®é¢˜ï¼šå¦‚æœæœ‰100ä¸ªæ˜æ˜Ÿï¼Œå°±éœ€è¦å†™100ä¸ªä¸åŒçš„ç»çºªäººï¼äºæ˜¯åŠ¨æ€ä»£ç†åº”è¿è€Œç”Ÿã€‚

### â–³ JDKåŠ¨æ€ä»£ç†

åŠ¨æ€ä»£ç†åƒæ˜¯ä¸€ä¸ªæ™ºèƒ½çš„ç»çºªäººæœºå™¨äººï¼Œå®ƒèƒ½åœ¨è¿è¡Œæ—¶è‡ªåŠ¨ç”Ÿæˆç»çºªäººï¼Œæ— è®ºä»€ä¹ˆæ˜æ˜Ÿéƒ½èƒ½é€‚é…ã€‚

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**

 - è¿è¡Œæ—¶ç”Ÿæˆä»£ç†ç±»ï¼Œæ— éœ€é¢„ç¼–è¯‘
 - ä¸€ä¸ªä»£ç†å¤„ç†å™¨å¯ä»¥æœåŠ¡å¤šä¸ªä¸åŒçš„ç›®æ ‡ç±»
 - ä»£ç å¤ç”¨æ€§æé«˜

**ä¸¤å¤§æ ¸å¿ƒï¼š**
**InvocationHandler è°ƒç”¨å¤„ç†å™¨ï¼š**
JDK æä¾›äº†ä¸€ä¸ªå·¥å…·ç±» java.lang.reflect.Proxyï¼Œå®ƒåªæœ‰ä¸€ä¸ªæ ¸å¿ƒé™æ€æ–¹æ³•ï¼Œç”¨æ¥ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œè¿™æ˜¯åŠ¨æ€ä»£ç†çš„å…¥å£ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š

```java
public static Object newProxyInstance(ClassLoader loader,
                                      Class<?>[] interfaces,
                                      InvocationHandler h)
```

 - å…¥å‚ 1ï¼šloader â†’ ç±»åŠ è½½å™¨ï¼ˆè¦ç´  2ï¼‰ï¼›
 - å…¥å‚ 2ï¼šinterfaces â†’ ç›®æ ‡ç±»å®ç°çš„æ‰€æœ‰æ¥å£ï¼ˆè¦ç´  1ï¼‰ï¼›
 - å…¥å‚ 3ï¼šh â†’ è°ƒç”¨å¤„ç†å™¨ï¼ˆè¦ç´  3ï¼Œä»£ç†çš„å¤§è„‘ï¼‰ï¼›


è¿”å›å€¼ï¼šJVM ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ï¼Œç›´æ¥å¼ºè½¬æˆæ¥å£ç±»å‹å³å¯ä½¿ç”¨ã€‚

**ä½¿ç”¨ï¼š**
åˆ›å»ºç›®æ ‡æ¥å£å’Œå®ç°ç±»ï¼ˆå†…åªæœ‰ä¸€ä¸ªloginæ–¹æ³• å‚æ•°éœ€è¦Userç±»ï¼‰ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/948d9cc04c1c4e9b9ce5bca2240aaf26.png)

**åˆ›å»ºæ ¸å¿ƒä¹‹ä¸€(InvocationHanlderå®ç°ç±»)ï¼š**

```java
public class MyInvocationHandler implements InvocationHandler {

    private final Object target;

    public MyInvocationHandler(Object target) {
        this.target = target;
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        System.out.println("å‰ç½®å¢å¼º");
        Object invoke = method.invoke(target, args);
        System.out.println("åç½®å¢å¼º");
        return invoke;
    }
}
```

**ä½¿ç”¨Proxyå·¥å…·çš„newProxyInstance()æ–¹æ³•ï¼š**

```java
public class JavaApplication {

    private static final UserService userService = new UserServiceImpl();

    private static final AdminService adminService = new AdminServiceImpl();

    public static void main(String[] args) throws Exception {

        UserService userProxy = (UserService) getProxy(
                userService.getClass().getClassLoader(),
                new Class[]{UserService.class},
                new MyInvocationHandler(userService)
        );

        userProxy.login(User.builder().username("å¼ ä¸‰").password("123456").build());

        AdminService adminProxy = (AdminService) getProxy(
                adminService.getClass().getClassLoader(),
                new Class[]{AdminService.class},
                new MyInvocationHandler(adminService)
        );

        adminProxy.login(User.builder().username("admin").password("123456").build());
    }

    /**
     * è·å–ä»£ç†å¯¹è±¡
     * @param classLoader ç›®æ ‡ç±»åŠ è½½å™¨
     * @param aclass ç›®æ ‡è¦å®ç°çš„æ¥å£
     * @param invocationHandler è‡ªå®šä¹‰å¤„ç†å™¨
     * @return è¿”å›ä»£ç†å¯¹è±¡
     */
    public static Object getProxy(ClassLoader classLoader, Class<?>[] aclass, InvocationHandler invocationHandler) {
        return Proxy.newProxyInstance(
                classLoader,
                aclass,
                invocationHandler
        );
    }

}
```

**åŠ¨æ€ä»£ç†çš„ã€Œæ ¸å¿ƒå·¥å…·ç±»ã€ï¼šProxy**

### â–³ JDKåŠ¨æ€ä»£ç†åº•å±‚åŸç†

JVM åˆ°åº•åœ¨èƒŒååšäº†ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè°ƒç”¨proxy.login()ï¼Œå°±ä¼šèµ°åˆ°invoke()æ–¹æ³•é‡Œï¼Ÿ

JVM çš„åº•å±‚æ‰§è¡Œæµç¨‹ï¼ˆè¿è¡Œæ—¶ï¼Œ4 æ­¥å®ŒæˆåŠ¨æ€ä»£ç†ï¼‰

 - â€œå‰§æœ¬â€è§„åˆ’ï¼šJVMæ£€æŸ¥ä½ ä¼ å…¥çš„æ¥å£æ•°ç»„ï¼Œç¡®è®¤å®ƒä»¬éƒ½æ˜¯æ¥å£ä¸”å¯è¢«ç±»åŠ è½½å™¨åŠ è½½ã€‚
 - â€œç”Ÿæˆå‰§æœ¬â€ï¼šè¿™æ˜¯æœ€æ ¸å¿ƒçš„ä¸€æ­¥ï¼ JVMä¼šåŠ¨æ€ç”Ÿæˆä¸€ä¸ªæ–°çš„ç±»çš„å­—èŠ‚ç ã€‚è¿™ä¸ªæ–°ç±»ï¼š
   é»˜è®¤ç»§æ‰¿è‡ª java.lang.reflect.Proxyã€‚
   å®ç°äº†ä½ æŒ‡å®šçš„æ‰€æœ‰æ¥å£ï¼ˆå¦‚ UserServiceï¼‰ã€‚
   ç±»åé€šå¸¸æ˜¯ç±»ä¼¼ Proxy0ã€Proxy1 è¿™æ ·çš„æ ¼å¼ã€‚
 - â€œæ‰¾æ¼”å‘˜â€ï¼šJVMä¼šå°è¯•ä»ç¼“å­˜ä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»ç”Ÿæˆè¿‡ç›¸åŒæ¥å£ç»„åˆçš„ä»£ç†ç±»ã€‚å¦‚æœæ²¡æœ‰ï¼Œå°±ç”¨å­—èŠ‚ç ç”Ÿæˆåº“ï¼ˆæ—©æœŸç‰ˆæœ¬æ˜¯ sun.misc.ProxyGeneratorï¼Œç°åœ¨æ›´åº•å±‚ï¼‰æŠŠä¸Šä¸€æ­¥è§„åˆ’çš„ç±»â€œç¼–è¯‘â€æˆå­—èŠ‚ç (byte[])ã€‚
 - â€œç™»å°è¡¨æ¼”â€ï¼šä½¿ç”¨ä½ ä¼ å…¥çš„ ClassLoaderï¼Œå°†è¿™ä¸ªæ–°ç”Ÿæˆçš„å­—èŠ‚æ•°ç»„åŠ¨æ€å®šä¹‰å¹¶åŠ è½½ä¸ºä¸€ä¸ªæ–°çš„ Class å¯¹è±¡ã€‚
 - â€œæ³¨å…¥çµé­‚â€ï¼šé€šè¿‡åå°„ï¼Œç”¨ä½ ä¼ å…¥çš„ InvocationHandler å®ä¾‹ä½œä¸ºå‚æ•°ï¼Œè°ƒç”¨è¿™ä¸ªæ–°ç”Ÿä»£ç†ç±»çš„æ„é€ å‡½æ•°ï¼Œå®ä¾‹åŒ–å‡ºæœ€ç»ˆçš„ä»£ç†å¯¹è±¡å¹¶è¿”å›ç»™ä½ ã€‚

**ä¸ºä»€ä¹ˆè°ƒç”¨ä»£ç†æ–¹æ³•ï¼Œä¼šèµ°åˆ° invoke () é‡Œ**
è‡ªåŠ¨ç”Ÿæˆçš„$Proxy0ç±»å†…ï¼Œå®ç°ä»£ç é€»è¾‘å¤§ä½“å¦‚æ­¤ï¼š

```java
public class $Proxy0 implements UserService{
    private InvocationHandler h;
    public $Proxy0(InvocationHandler h) {
        this.h = h;
    }
    @Override
    public void login() {
        // è°ƒç”¨InvocationHandlerçš„invokeæ–¹æ³•ï¼ŒæŠŠå½“å‰æ–¹æ³•ã€å‚æ•°ä¼ è¿›å»
        h.invoke(this, UserService.class.getMethod("å¼ ä¸‰"), null);
    }
}
```

### â–³ CGLIBåŠ¨æ€ä»£ç†

CGLIB åŠ¨æ€ä»£ç† = åŸºäºã€Œå­ç±»ã€çš„åŠ¨æ€ä»£ç†ï¼Œæ— æ¥å£è¦æ±‚ï¼ŒJVM è‡ªåŠ¨ç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»ä½œä¸ºä»£ç†ç±»

ä½ ä¸ç”¨å†™ä»»ä½•ä»£ç†ç±»ä»£ç ï¼Œä¹Ÿä¸ç”¨ç»™ç›®æ ‡ç±»åŠ æ¥å£ï¼Œåªéœ€è¦å‘Šè¯‰ CGLIBã€Œè¦ä»£ç†å“ªä¸ªç±»ã€ã€Œè¦åŠ ä»€ä¹ˆå¢å¼ºé€»è¾‘ã€ï¼ŒJVM åœ¨è¿è¡Œæ—¶ä¼šè‡ªåŠ¨åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ª ç›®æ ‡ç±»çš„å­ç±» ä½œä¸ºä»£ç†ç±»ï¼Œè¿™ä¸ªå­ç±»å°±æ˜¯ä»£ç†å¯¹è±¡ï¼Œèƒ½å®Œç¾æ›¿ç›®æ ‡ç±»å¹²æ´»ï¼Œè¿˜èƒ½åŠ å¢å¼ºé€»è¾‘ï¼Œç›®æ ‡ç±»çš„ä»£ç ä¸€è¡Œä¸ç”¨æ”¹ã€‚


 CGLIB vs JDK æ ¸å¿ƒæœ¬è´¨åŒºåˆ«

 - ğŸ’¡ JDK åŠ¨æ€ä»£ç†ï¼šåŸºäºã€æ¥å£ã€‘å®ç°ï¼Œä»£ç†ç±» â‰ˆ ç›®æ ‡ç±»çš„ã€Œå¹³çº§å…„å¼Ÿã€
 - ğŸ’¡ CGLIB åŠ¨æ€ä»£ç†ï¼šåŸºäºã€å­ç±»ã€‘å®ç°ï¼Œä»£ç†ç±» â‰ˆ ç›®æ ‡ç±»çš„ã€Œäº²å„¿å­ã€

å› ä¸ºCGLIBä¸æ˜¯JDKç±»åº“ä¸­è‡ªå¸¦çš„éœ€è¦å¯¼å…¥jaråŒ…æˆ–ä¾èµ–ï¼š

```java
<dependency>
    <groupId>cglib</groupId>
    <artifactId>cglib</artifactId>
    <version>3.3.0</version>
    <scope>compile</scope>
</dependency>

å¦‚æœæ˜¯jdk21åŠä»¥ä¸Šç›´æ¥å¯¼å…¥springä¾èµ–å³å¯
cglibä¸é€‚é…jdk21
è€Œspringå†…ç½®çš„cglibåšäº†é‡æ„é€‚é…jdk21

<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-core</artifactId>
    <version>6.2.2</version>
</dependency>
```

**CGLIBä¸¤å¤§æ ¸å¿ƒ(å¯¹åº”JDKä¸¤å¤§æ ¸å¿ƒ)ï¼š**

- MethodInterceptoræ–¹æ³•æ‹¦æˆªå™¨ï¼ˆå¯¹åº”JDKçš„InvocationHandleré€»è¾‘å®Œå…¨ä¸€è‡´ï¼‰
- Enhancerï¼ˆå¯¹åº”JDKçš„Proxyé€»è¾‘å®Œå…¨ä¸€è‡´ï¼‰

**CGLIBåŸºæœ¬å®ç°**

å®ç°MethodInterceptorç±»çš„å®ç°ç±»ï¼š

```java
public class MyInterceptor implements MethodInterceptor {
    /**
     *
     * @param o åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»å¯¹è±¡
     * @param method ä»£ç†å¯¹è±¡ç”Ÿæˆçš„ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•
     * @param objects å‚æ•°åˆ—è¡¨
     * @param methodProxy CGLIBæ–¹æ³•ä»£ç†å¯¹è±¡
     * @return è¿”å›ç”Ÿæˆçš„ä»£ç†å¯¹è±¡
     */
    @Override
    public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable {
        System.out.println("å‰ç½®å¢å¼º");
        //ç”¨invokeSuperæ•ˆç‡æ›´é«˜
        Object result = methodProxy.invokeSuper(o, objects);
//        method.invoke(o,objects);
        System.out.println("åç½®å¢å¼º");
        return result;
    }
}
```

æµ‹è¯•ï¼š

```java
public class JavaApplication {
    
    public static void main(String[] args) {
        // 1. åˆ›å»ºCGLIBçš„æ ¸å¿ƒå·¥å…·ç±»ï¼šå¢å¼ºå™¨
        Enhancer enhancer = new Enhancer();

        // 2. æ ¸å¿ƒé…ç½®1ï¼šå‘Šè¯‰CGLIBï¼Œè¦ç»™å“ªä¸ªç±»ç”Ÿæˆå­ç±»ä»£ç†ï¼ˆè®¾ç½®çˆ¶ç±»=ç›®æ ‡ç±»ï¼‰
        enhancer.setSuperclass(UserService.class);

        // 3. æ ¸å¿ƒé…ç½®2ï¼šè®¾ç½®æ–¹æ³•æ‹¦æˆªå™¨ï¼ˆä»£ç†çš„å¤§è„‘ï¼Œå¢å¼ºé€»è¾‘åœ¨è¿™é‡Œï¼‰
        enhancer.setCallback(new MyInterceptor());

        // 4. ç”Ÿæˆä»£ç†å¯¹è±¡ï¼šJVMåœ¨å†…å­˜ä¸­åŠ¨æ€ç”Ÿæˆå­ç±»ï¼Œå¼ºè½¬ä¸ºç›®æ ‡ç±»å³å¯
        UserService proxy = (UserService) enhancer.create();

        // 5. è°ƒç”¨ä»£ç†å¯¹è±¡çš„å¸¦å‚æ•°æ–¹æ³•ï¼ã€é‡ç‚¹ï¼šç›´æ¥ä¼ å‚ï¼Œå’Œè°ƒç”¨æ™®é€šæ–¹æ³•å®Œå…¨ä¸€æ ·ã€‘
        proxy.login(User.builder().username("å¼ ä¸‰").build());
    }
}
```

### â–³ CGLIBåŠ¨æ€ä»£ç†åº•å±‚åŸç†

**JDK åŠ¨æ€ä»£ç†åº•å±‚ï¼š**
è¿è¡Œæ—¶ â†’ JVM åå°„è¯»å–æ¥å£ä¿¡æ¯ â†’ ç”Ÿæˆå®ç°è¯¥æ¥å£çš„ä»£ç†ç±»$Proxy0 â†’ åˆ›å»ºä»£ç†å¯¹è±¡ â†’ è°ƒç”¨æ–¹æ³•èµ°åˆ°invoke()ã€‚

**CGLIB åŠ¨æ€ä»£ç†åº•å±‚ï¼š**
è¿è¡Œæ—¶ â†’ CGLIB é€šè¿‡ ASM å­—èŠ‚ç æ¡†æ¶ â†’ åŠ¨æ€ç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»ï¼Œç±»åé»˜è®¤æ˜¯

```java
ç›®æ ‡ç±»å$$EnhancerByCGLIB$$åœ°å€å€¼
```

## â—‹ [\[Git\]æ‰‹å†™JDKåŠ¨æ€ä»£ç†](https://github.com/Lotdzzz/javaSE-project/tree/JavaDynamicProxy)

## â—‹ [Git]æ‰‹å†™Springä¾èµ–æ³¨å…¥ä»¥åŠAOP